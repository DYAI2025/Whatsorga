<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsOrga Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2a2d3a;
      --text: #e4e4e7;
      --text-dim: #8b8d97;
      --accent: #6366f1;
      --accent-dim: #4f46e5;
      --positive: #22c55e;
      --negative: #ef4444;
      --warning: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-controls input,
    .header-controls select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
    }

    .header-controls button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .header-controls button:hover { background: var(--accent-dim); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      padding: 20px 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }

    .card h2 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .card-wide { grid-column: 1 / -1; }

    /* Overview stats */
    .stats-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .stat {
      flex: 1;
      min-width: 120px;
      text-align: center;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .stat-positive .stat-value { color: var(--positive); }
    .stat-negative .stat-value { color: var(--negative); }
    .stat-accent .stat-value { color: var(--accent); }
    .stat-warning .stat-value { color: var(--warning); }

    /* Chart containers */
    .chart-container {
      position: relative;
      height: 260px;
    }

    /* Thread list */
    .thread-list { list-style: none; max-height: 300px; overflow-y: auto; }
    .thread-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .thread-item:last-child { border-bottom: none; }
    .thread-theme { font-size: 14px; font-weight: 500; }
    .thread-meta { font-size: 12px; color: var(--text-dim); }
    .thread-status {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 500;
    }
    .thread-status.active { background: #22c55e22; color: var(--positive); }
    .thread-status.dormant { background: #f59e0b22; color: var(--warning); }
    .thread-status.resolved { background: #6366f122; color: var(--accent); }

    /* Termine list */
    .termin-list { list-style: none; max-height: 300px; overflow-y: auto; }
    .termin-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .termin-item:last-child { border-bottom: none; }
    .termin-title { font-size: 14px; font-weight: 500; }
    .termin-datetime { font-size: 12px; color: var(--accent); margin-top: 2px; }
    .termin-participants { font-size: 12px; color: var(--text-dim); }
    .termin-synced {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 8px;
      background: #22c55e22;
      color: var(--positive);
      margin-left: 6px;
    }

    /* Search */
    .search-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .search-bar input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
    }

    .search-bar button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    .search-results { list-style: none; max-height: 300px; overflow-y: auto; }
    .search-result-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-text { font-size: 13px; line-height: 1.4; }
    .search-meta { font-size: 11px; color: var(--text-dim); margin-top: 4px; }

    /* Feedback buttons */
    .termin-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .termin-actions button {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .termin-actions button:hover { opacity: 0.85; }
    .btn-confirm { background: rgba(34,197,94,0.2); color: #22c55e; }
    .btn-reject { background: rgba(239,68,68,0.2); color: #ef4444; }
    .btn-edit { background: rgba(99,102,241,0.2); color: #6366f1; }
    .btn-cancel-edit { background: rgba(139,141,151,0.2); color: #8b8d97; }
    .btn-save { background: var(--accent); color: white; }

    .termin-status-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      padding: 1px 7px;
      border-radius: 8px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-left: 6px;
    }
    .badge-auto { background: rgba(34,197,94,0.15); color: #22c55e; }
    .badge-suggested { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .badge-confirmed { background: rgba(99,102,241,0.15); color: #6366f1; }
    .badge-rejected { background: rgba(239,68,68,0.15); color: #ef4444; }
    .badge-cancelled { background: rgba(139,141,151,0.15); color: #8b8d97; }

    .termin-confidence {
      display: inline-block;
      font-size: 10px;
      color: var(--text-dim);
      margin-left: 6px;
    }

    .termin-edit-form {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
      padding: 10px;
      background: var(--bg);
      border-radius: 8px;
    }
    .termin-edit-form label {
      font-size: 11px;
      color: var(--text-dim);
    }
    .termin-edit-form input,
    .termin-edit-form select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .termin-edit-actions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .reject-reason {
      margin-top: 6px;
    }
    .reject-reason input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 5px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .reject-reason-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .termin-feedback-done {
      font-size: 12px;
      font-weight: 500;
      margin-top: 6px;
      padding: 4px 0;
    }

    .past-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-dim);
    }
    .past-toggle input[type="checkbox"] {
      accent-color: var(--accent);
    }

    /* Communication pattern heatmap */
    .comm-heatmap {
      display: grid;
      grid-template-columns: 50px repeat(24, 1fr);
      gap: 2px;
    }
    .comm-heatmap-label {
      font-size: 10px;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 6px;
    }
    .comm-heatmap-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      min-height: 16px;
      position: relative;
      cursor: default;
    }
    .comm-heatmap-cell:hover {
      outline: 1px solid var(--text-dim);
    }
    .comm-hour-labels {
      display: grid;
      grid-template-columns: 50px repeat(24, 1fr);
      gap: 2px;
      margin-bottom: 4px;
    }
    .comm-hour-label {
      font-size: 9px;
      color: var(--text-dim);
      text-align: center;
    }
    .comm-legend {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-dim);
    }
    .comm-legend-bar {
      display: flex;
      gap: 1px;
      margin: 0 4px;
    }
    .comm-legend-swatch {
      width: 14px;
      height: 10px;
      border-radius: 2px;
    }
    .comm-total {
      margin-left: auto;
      font-size: 11px;
      color: var(--text-dim);
    }

    /* Response times */
    .rt-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .rt-person {
      background: var(--bg);
      border-radius: 8px;
      padding: 14px;
    }
    .rt-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rt-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .rt-bar-label {
      font-size: 11px;
      color: var(--text-dim);
      width: 72px;
      flex-shrink: 0;
      text-align: right;
    }
    .rt-bar-track {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .rt-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s ease;
    }
    .rt-bar-value {
      font-size: 11px;
      color: var(--text);
      font-weight: 600;
      width: 52px;
      flex-shrink: 0;
    }
    .rt-meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
    }

    /* Heatmap */
    .heatmap-grid {
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow-x: auto;
    }
    .heatmap-row {
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .heatmap-label {
      width: 80px;
      font-size: 11px;
      color: var(--text-dim);
      text-align: right;
      padding-right: 6px;
      flex-shrink: 0;
    }
    .heatmap-cell {
      width: 28px;
      height: 20px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .heatmap-date-labels {
      display: flex;
      gap: 2px;
      margin-left: 86px;
    }
    .heatmap-date {
      width: 28px;
      font-size: 9px;
      color: var(--text-dim);
      text-align: center;
      flex-shrink: 0;
    }

    .empty-state {
      text-align: center;
      color: var(--text-dim);
      padding: 40px 20px;
      font-size: 14px;
    }

    /* Service status */
    .service-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .service-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      background: var(--bg);
      font-size: 12px;
      font-weight: 500;
    }
    .service-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .service-dot.ok { background: var(--positive); }
    .service-dot.error { background: var(--negative); }
    .service-dot.off { background: var(--text-dim); }
    .service-dot.idle { background: var(--warning); }
    .service-detail {
      color: var(--text-dim);
      font-weight: 400;
    }

    /* Auth */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .auth-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      width: 340px;
    }
    .auth-box h2 { margin-bottom: 16px; font-size: 18px; color: var(--text); }
    .auth-box input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .auth-box button {
      width: 100%;
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .auth-error { color: var(--negative); font-size: 13px; margin-top: 8px; }

    .nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      gap: 0;
    }
    .nav a {
      color: var(--text-dim);
      text-decoration: none;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .nav a:hover { color: var(--text); }
    .nav a.active { color: var(--accent); border-bottom-color: var(--accent); }
  </style>
</head>
<body>

<!-- Auth screen -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2>WhatsOrga</h2>
    <input type="password" id="authKey" placeholder="API-Key eingeben">
    <input type="text" id="authChatId" placeholder="Chat-ID eingeben">
    <button onclick="authenticate()">Verbinden</button>
    <div class="auth-error" id="authError"></div>
  </div>
</div>

<!-- Main dashboard -->
<header>
  <h1>WhatsOrga</h1>
  <div class="header-controls">
    <span id="chatLabel" style="font-size:13px;color:var(--text-dim)"></span>
    <select id="driftDays" onchange="loadDrift();loadCommPattern();loadResponseTimes()">
      <option value="7">7 Tage</option>
      <option value="14">14 Tage</option>
      <option value="30" selected>30 Tage</option>
      <option value="90">90 Tage</option>
    </select>
    <button onclick="refreshAll()">Aktualisieren</button>
  </div>
</header>

<nav class="nav">
  <a href="/dashboard" class="active">Dashboard</a>
  <a href="/dashboard/pipeline">Pipeline</a>
  <a href="/dashboard/charts">Charts</a>
  <a href="/dashboard/monitoring">Monitoring</a>
</nav>

<div class="grid">
  <!-- Overview stats -->
  <div class="card card-wide" id="overviewCard">
    <h2>Zusammenfassung</h2>
    <div class="stats-row" id="statsRow">
      <div class="stat stat-accent">
        <div class="stat-value" id="statMessages">-</div>
        <div class="stat-label">Nachrichten</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statSentiment">-</div>
        <div class="stat-label">Stimmung (7d)</div>
      </div>
      <div class="stat stat-accent">
        <div class="stat-value" id="statThreads">-</div>
        <div class="stat-label">Aktive Themen</div>
      </div>
      <div class="stat stat-warning">
        <div class="stat-value" id="statTermine">-</div>
        <div class="stat-label">Anstehende Termine</div>
      </div>
    </div>
  </div>

  <!-- Service status -->
  <div class="card card-wide" id="statusCard">
    <h2>Service-Status</h2>
    <div class="service-grid" id="serviceGrid">
      <div class="service-pill"><span class="service-dot off"></span>Lade...</div>
    </div>
  </div>

  <!-- Drift chart -->
  <div class="card card-wide">
    <h2>Stimmungsverlauf</h2>
    <div class="chart-container">
      <canvas id="driftChart"></canvas>
    </div>
    <div id="markerLegend" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;"></div>
  </div>

  <!-- Marker heatmap -->
  <div class="card card-wide">
    <h2>Marker-Heatmap</h2>
    <div id="heatmapContainer"></div>
  </div>

  <!-- Communication Pattern -->
  <div class="card card-wide">
    <h2>Kommunikationsmuster</h2>
    <div id="commPatternContainer">
      <div class="empty-state">Lade...</div>
    </div>
  </div>

  <!-- Response Times -->
  <div class="card card-wide">
    <h2>Antwortzeiten</h2>
    <div id="responseTimesContainer">
      <div class="empty-state">Lade...</div>
    </div>
  </div>

  <!-- Threads -->
  <div class="card">
    <h2>Semantische Themen</h2>
    <ul class="thread-list" id="threadList">
      <li class="empty-state">Lade...</li>
    </ul>
  </div>

  <!-- Termine -->
  <div class="card">
    <h2>Termine</h2>
    <div class="past-toggle">
      <input type="checkbox" id="showPastTermine" onchange="loadTermine()">
      <label for="showPastTermine">Vergangene anzeigen</label>
    </div>
    <ul class="termin-list" id="terminList">
      <li class="empty-state">Lade...</li>
    </ul>
  </div>

  <!-- Search -->
  <div class="card card-wide">
    <h2>Semantische Suche</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Nachrichten durchsuchen..."
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">Suchen</button>
    </div>
    <ul class="search-results" id="searchResults">
      <li class="empty-state">Suchbegriff eingeben und Enter drucken</li>
    </ul>
  </div>
</div>

<script>
let API_KEY = '';
let CHAT_ID = '';
let driftChart = null;

const MARKER_COLORS = {
  waerme: '#22c55e', distanz: '#3b82f6', stress: '#ef4444',
  konflikt: '#f97316', freude: '#fbbf24', trauer: '#8b5cf6',
  fuersorge: '#ec4899', planung: '#06b6d4', dankbarkeit: '#10b981',
  unsicherheit: '#6b7280',
};

function headers() {
  return { Authorization: 'Bearer ' + API_KEY, 'Content-Type': 'application/json' };
}

async function apiFetch(path) {
  const resp = await fetch(path, { headers: headers() });
  if (!resp.ok) throw new Error(`API error ${resp.status}`);
  return resp.json();
}

function authenticate() {
  API_KEY = document.getElementById('authKey').value.trim();
  CHAT_ID = document.getElementById('authChatId').value.trim();
  if (!API_KEY || !CHAT_ID) {
    document.getElementById('authError').textContent = 'Bitte beide Felder ausfuellen';
    return;
  }
  // Test auth
  apiFetch(`/api/overview/${encodeURIComponent(CHAT_ID)}`)
    .then(() => {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('chatLabel').textContent = CHAT_ID;
      localStorage.setItem('radar_key', API_KEY);
      localStorage.setItem('radar_chat', CHAT_ID);
      refreshAll();
    })
    .catch(err => {
      document.getElementById('authError').textContent = 'Verbindung fehlgeschlagen: ' + err.message;
    });
}

function refreshAll() {
  loadOverview();
  loadDrift();
  loadMarkers();
  loadCommPattern();
  loadResponseTimes();
  loadThreads();
  loadTermine();
  loadStatus();
}

async function loadOverview() {
  try {
    const data = await apiFetch(`/api/overview/${encodeURIComponent(CHAT_ID)}`);
    document.getElementById('statMessages').textContent = data.total_messages;
    const sent = data.avg_sentiment_7d;
    const sentEl = document.getElementById('statSentiment');
    sentEl.textContent = sent > 0 ? `+${sent}` : sent;
    sentEl.parentElement.className = `stat ${sent > 0 ? 'stat-positive' : sent < 0 ? 'stat-negative' : ''}`;
    document.getElementById('statThreads').textContent = data.active_threads;
    document.getElementById('statTermine').textContent = data.upcoming_termine;
  } catch (e) {
    console.error('Overview error:', e);
  }
}

async function loadDrift() {
  const days = document.getElementById('driftDays').value;
  try {
    const data = await apiFetch(`/api/drift-markers/${encodeURIComponent(CHAT_ID)}?days=${days}`);
    renderDriftChart(data.data);
  } catch (e) {
    console.error('Drift error:', e);
  }
}

function renderDriftChart(points) {
  const ctx = document.getElementById('driftChart').getContext('2d');
  if (driftChart) driftChart.destroy();

  const labels = points.map(p => p.date);
  const sentiments = points.map(p => p.avg_sentiment);
  const counts = points.map(p => p.message_count);

  const pointColors = points.map(p => {
    if (p.dominant_marker && MARKER_COLORS[p.dominant_marker]) {
      return MARKER_COLORS[p.dominant_marker];
    }
    return '#6366f1';
  });

  const pointRadii = points.map(p => p.dominant_marker ? 6 : 3);

  driftChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Stimmung',
          data: sentiments,
          borderColor: '#6366f188',
          pointBackgroundColor: pointColors,
          pointBorderColor: pointColors,
          pointRadius: pointRadii,
          pointHoverRadius: 8,
          fill: false,
          tension: 0.3,
          yAxisID: 'y',
        },
        {
          label: 'Nachrichten',
          data: counts,
          borderColor: '#8b8d9744',
          backgroundColor: '#8b8d9711',
          fill: false,
          tension: 0.3,
          yAxisID: 'y1',
          borderDash: [4, 4],
          pointRadius: 0,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      scales: {
        x: {
          ticks: { color: '#8b8d97', maxTicksLimit: 10 },
          grid: { color: '#2a2d3a' },
        },
        y: {
          position: 'left',
          min: -1, max: 1,
          ticks: { color: '#6366f1' },
          grid: { color: '#2a2d3a' },
          title: { display: true, text: 'Stimmung', color: '#6366f1' },
        },
        y1: {
          position: 'right',
          ticks: { color: '#8b8d97' },
          grid: { display: false },
          title: { display: true, text: 'Nachrichten', color: '#8b8d97' },
        },
      },
      plugins: {
        legend: { labels: { color: '#e4e4e7' } },
        tooltip: {
          callbacks: {
            afterBody: function(context) {
              const idx = context[0].dataIndex;
              const point = points[idx];
              if (!point.markers || Object.keys(point.markers).length === 0) return '';
              const lines = ['', 'Marker:'];
              const sorted = Object.entries(point.markers).sort((a, b) => b[1] - a[1]);
              for (const [marker, count] of sorted.slice(0, 5)) {
                lines.push(`  ${marker}: ${count}`);
              }
              return lines.join('\n');
            }
          }
        },
      },
    },
  });

  // Populate marker legend
  const legendEl = document.getElementById('markerLegend');
  const usedMarkers = new Set(points.map(p => p.dominant_marker).filter(Boolean));
  legendEl.innerHTML = Array.from(usedMarkers).map(m =>
    `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--text-dim)">
      <span style="width:8px;height:8px;border-radius:50%;background:${MARKER_COLORS[m]||'#6366f1'}"></span>${m}
    </span>`
  ).join('');
}

async function loadMarkers() {
  try {
    const data = await apiFetch(`/api/markers/${encodeURIComponent(CHAT_ID)}?days=7`);
    renderHeatmap(data.data);
  } catch (e) {
    console.error('Markers error:', e);
  }
}

function renderHeatmap(dayData) {
  const container = document.getElementById('heatmapContainer');
  if (!dayData.length) {
    container.innerHTML = '<div class="empty-state">Keine Marker-Daten vorhanden</div>';
    return;
  }

  // Get all unique markers
  const allMarkers = new Set();
  dayData.forEach(d => Object.keys(d.markers).forEach(m => allMarkers.add(m)));
  const markers = Array.from(allMarkers).sort();
  const dates = dayData.map(d => d.date);

  // Find max for color scaling
  let maxVal = 1;
  dayData.forEach(d => Object.values(d.markers).forEach(v => { if (v > maxVal) maxVal = v; }));

  let html = '<div class="heatmap-grid">';

  // Date labels
  html += '<div class="heatmap-date-labels">';
  dates.forEach(d => {
    const short = d.slice(5); // MM-DD
    html += `<div class="heatmap-date">${short}</div>`;
  });
  html += '</div>';

  // Rows per marker
  markers.forEach(marker => {
    html += '<div class="heatmap-row">';
    html += `<div class="heatmap-label">${marker}</div>`;
    dates.forEach(d => {
      const dayObj = dayData.find(dd => dd.date === d);
      const val = dayObj ? (dayObj.markers[marker] || 0) : 0;
      const intensity = Math.min(val / maxVal, 1);
      const baseColor = MARKER_COLORS[marker] || '#6366f1';
      const bg = intensity === 0 ? '#1a1d27' : hexToRgba(baseColor, 0.2 + intensity * 0.8);
      html += `<div class="heatmap-cell" style="background:${bg}" title="${marker}: ${val} (${d})"></div>`;
    });
    html += '</div>';
  });

  html += '</div>';
  container.innerHTML = html;
}

function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

async function loadCommPattern() {
  const container = document.getElementById('commPatternContainer');
  try {
    const days = document.getElementById('driftDays').value;
    const data = await apiFetch(`/api/communication-pattern/${encodeURIComponent(CHAT_ID)}?days=${days}`);
    renderCommPattern(data);
  } catch (e) {
    console.error('CommPattern error:', e);
    container.innerHTML = '<div class="empty-state">Fehler beim Laden</div>';
  }
}

function renderCommPattern(data) {
  const container = document.getElementById('commPatternContainer');
  const heatmap = data.heatmap; // 7x24 matrix
  const total = data.total_messages;
  const dayLabels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

  if (!total) {
    container.innerHTML = '<div class="empty-state">Keine Nachrichtendaten</div>';
    return;
  }

  // Find max value for color scaling (use 95th percentile to avoid outlier domination)
  const allVals = [];
  for (let d = 0; d < 7; d++)
    for (let h = 0; h < 24; h++)
      if (heatmap[d][h] > 0) allVals.push(heatmap[d][h]);
  allVals.sort((a, b) => a - b);
  const p95 = allVals.length > 0 ? allVals[Math.floor(allVals.length * 0.95)] : 1;
  const maxVal = Math.max(p95, 1);

  // Hour labels row
  let html = '<div class="comm-hour-labels"><div></div>';
  for (let h = 0; h < 24; h++) {
    html += `<div class="comm-hour-label">${h}</div>`;
  }
  html += '</div>';

  // Grid
  html += '<div class="comm-heatmap">';
  for (let d = 0; d < 7; d++) {
    html += `<div class="comm-heatmap-label">${dayLabels[d]}</div>`;
    for (let h = 0; h < 24; h++) {
      const val = heatmap[d][h];
      const intensity = val / maxVal;
      const bg = val === 0
        ? 'var(--bg)'
        : `rgba(99, 102, 241, ${0.15 + intensity * 0.85})`;
      html += `<div class="comm-heatmap-cell" style="background:${bg}" title="${dayLabels[d]} ${h}:00 — ${val} Nachrichten"></div>`;
    }
  }
  html += '</div>';

  // Legend
  html += '<div class="comm-legend">';
  html += '<span>Weniger</span><div class="comm-legend-bar">';
  const steps = [0, 0.25, 0.5, 0.75, 1];
  for (const s of steps) {
    const bg = s === 0 ? 'var(--bg)' : `rgba(99, 102, 241, ${0.15 + s * 0.85})`;
    html += `<div class="comm-legend-swatch" style="background:${bg};border:1px solid var(--border)"></div>`;
  }
  html += '</div><span>Mehr</span>';
  html += `<span class="comm-total">${total} Nachrichten gesamt</span>`;
  html += '</div>';

  container.innerHTML = html;
}

async function loadResponseTimes() {
  const container = document.getElementById('responseTimesContainer');
  try {
    const days = document.getElementById('driftDays').value;
    const data = await apiFetch(`/api/response-times/${encodeURIComponent(CHAT_ID)}?days=${days}`);
    renderResponseTimes(data);
  } catch (e) {
    console.error('ResponseTimes error:', e);
    container.innerHTML = '<div class="empty-state">Fehler beim Laden</div>';
  }
}

function renderResponseTimes(data) {
  const container = document.getElementById('responseTimesContainer');
  // Filter out senders with too few responses (unreliable avg)
  const rt = (data.response_times || []).filter(r => r.response_count >= 3);

  if (!rt.length) {
    container.innerHTML = '<div class="empty-state">Nicht genug Daten</div>';
    return;
  }

  // Use p90 for bar scaling to avoid outlier domination
  const avgs = rt.map(r => r.avg_response_minutes || 0).sort((a, b) => a - b);
  const p90 = avgs[Math.floor(avgs.length * 0.9)] || avgs[avgs.length - 1] || 1;
  const maxAvg = Math.max(p90, 1);

  let html = '<div class="rt-grid">';
  for (const r of rt) {
    const avgMin = r.avg_response_minutes;
    const avgLabel = avgMin != null ? formatDuration(avgMin) : '–';
    const pct = avgMin != null ? Math.min((avgMin / maxAvg) * 100, 100) : 0;

    // Color: green=fast (<15min), yellow=moderate (<60min), orange=slow
    let barColor = 'var(--positive)';
    if (avgMin != null) {
      if (avgMin > 60) barColor = 'var(--warning)';
      else if (avgMin > 15) barColor = '#eab308';
    }

    html += `
      <div class="rt-person">
        <div class="rt-name">${esc(r.sender)}</div>
        <div class="rt-bar-row">
          <span class="rt-bar-label">Ø Antwort</span>
          <div class="rt-bar-track">
            <div class="rt-bar-fill" style="width:${pct}%;background:${barColor}"></div>
          </div>
          <span class="rt-bar-value">${avgLabel}</span>
        </div>
        <div class="rt-meta">
          <span>${r.message_count} Nachrichten</span>
          <span>${r.response_count} Antworten</span>
        </div>
      </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function formatDuration(minutes) {
  if (minutes < 1) return '<1 min';
  if (minutes < 60) return Math.round(minutes) + ' min';
  const h = Math.floor(minutes / 60);
  const m = Math.round(minutes % 60);
  return m > 0 ? h + 'h ' + m + 'm' : h + 'h';
}

async function loadThreads() {
  try {
    const data = await apiFetch(`/api/threads/${encodeURIComponent(CHAT_ID)}`);
    const list = document.getElementById('threadList');
    if (!data.threads.length) {
      list.innerHTML = '<li class="empty-state">Keine Themen erkannt</li>';
      return;
    }
    list.innerHTML = data.threads.map(t => `
      <li class="thread-item">
        <div>
          <div class="thread-theme">${esc(t.theme)}</div>
          <div class="thread-meta">${t.message_count} Nachrichten${t.updated_at ? ' &middot; ' + formatDate(t.updated_at) : ''}</div>
        </div>
        <span class="thread-status ${t.status}">${t.status}</span>
      </li>
    `).join('');
  } catch (e) {
    console.error('Threads error:', e);
  }
}

async function loadTermine() {
  try {
    const includePast = document.getElementById('showPastTermine').checked;
    const url = `/api/termine/${encodeURIComponent(CHAT_ID)}${includePast ? '?include_past=true' : ''}`;
    const data = await apiFetch(url);
    const list = document.getElementById('terminList');
    if (!data.termine.length) {
      list.innerHTML = '<li class="empty-state">Keine Termine</li>';
      return;
    }
    list.innerHTML = data.termine.map(t => renderTerminItem(t)).join('');
  } catch (e) {
    console.error('Termine error:', e);
  }
}

function renderTerminItem(t) {
  const badgeClass = 'badge-' + (t.status || 'auto');
  const statusLabels = {auto:'Auto',suggested:'Vorschlag',confirmed:'Bestätigt',rejected:'Abgelehnt',cancelled:'Abgesagt'};
  const statusLabel = statusLabels[t.status] || t.status;
  const confPct = t.confidence ? Math.round(t.confidence * 100) + '%' : '';
  const isDone = t.status === 'confirmed' || t.status === 'rejected';

  let actionsHtml = '';
  if (!isDone) {
    actionsHtml = `
      <div class="termin-actions" id="actions-${t.id}">
        <button class="btn-confirm" onclick="confirmTermin('${t.id}')">Bestätigen</button>
        <button class="btn-reject" onclick="showRejectForm('${t.id}')">Ablehnen</button>
        <button class="btn-edit" onclick="showEditForm('${t.id}', this)">Bearbeiten</button>
      </div>`;
  } else {
    actionsHtml = `<div class="termin-feedback-done" style="color:${t.status==='confirmed'?'var(--positive)':'var(--negative)'}">
      ${t.status==='confirmed'?'✓ Bestätigt':'✗ Abgelehnt'}</div>`;
  }

  return `
    <li class="termin-item" id="termin-${t.id}" data-termin='${esc(JSON.stringify(t))}'>
      <div class="termin-title">
        ${esc(t.title)}
        <span class="termin-status-badge ${badgeClass}">${esc(statusLabel)}</span>
        ${t.caldav_synced ? '<span class="termin-synced">Kalender</span>' : ''}
        ${confPct ? '<span class="termin-confidence">' + confPct + '</span>' : ''}
      </div>
      <div class="termin-datetime">${t.datetime ? formatDate(t.datetime) : '-'}${t.location ? ' · ' + esc(t.location) : ''}</div>
      <div class="termin-participants">${(t.participants || []).join(', ')}</div>
      ${actionsHtml}
    </li>`;
}

async function confirmTermin(id) {
  try {
    await fetch(`/api/termine/${id}/feedback`, {
      method: 'POST', headers: headers(),
      body: JSON.stringify({action: 'confirmed'})
    });
    updateTerminUI(id, 'confirmed');
  } catch (e) { console.error('Confirm error:', e); }
}

function showRejectForm(id) {
  const actionsEl = document.getElementById('actions-' + id);
  if (!actionsEl) return;
  actionsEl.innerHTML = `
    <div class="reject-reason">
      <input type="text" id="reject-reason-${id}" placeholder="Grund (optional)">
      <div class="reject-reason-actions">
        <button class="btn-reject" onclick="rejectTermin('${id}')">Ablehnen</button>
        <button class="btn-cancel-edit" onclick="loadTermine()">Abbrechen</button>
      </div>
    </div>`;
}

async function rejectTermin(id) {
  const reason = document.getElementById('reject-reason-' + id)?.value || '';
  try {
    await fetch(`/api/termine/${id}/feedback`, {
      method: 'POST', headers: headers(),
      body: JSON.stringify({action: 'rejected', reason: reason || null})
    });
    updateTerminUI(id, 'rejected');
  } catch (e) { console.error('Reject error:', e); }
}

function showEditForm(id) {
  const li = document.getElementById('termin-' + id);
  if (!li) return;
  const t = JSON.parse(li.dataset.termin);
  const dtLocal = t.datetime ? t.datetime.slice(0, 16) : '';

  const actionsEl = document.getElementById('actions-' + id);
  if (!actionsEl) return;
  actionsEl.innerHTML = `
    <div class="termin-edit-form">
      <label>Titel</label>
      <input type="text" id="edit-title-${id}" value="${esc(t.title || '')}">
      <label>Datum/Uhrzeit</label>
      <input type="datetime-local" id="edit-datetime-${id}" value="${dtLocal}">
      <label>Ort</label>
      <input type="text" id="edit-location-${id}" value="${esc(t.location || '')}">
      <div style="display:flex;gap:12px">
        <div style="flex:1">
          <label>Kategorie</label>
          <select id="edit-category-${id}">
            <option value="appointment" ${t.category==='appointment'?'selected':''}>Termin</option>
            <option value="reminder" ${t.category==='reminder'?'selected':''}>Erinnerung</option>
            <option value="task" ${t.category==='task'?'selected':''}>Aufgabe</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Relevanz</label>
          <select id="edit-relevance-${id}">
            <option value="for_me" ${t.relevance==='for_me'?'selected':''}>Für mich</option>
            <option value="shared" ${t.relevance==='shared'?'selected':''}>Geteilt</option>
            <option value="partner_only" ${t.relevance==='partner_only'?'selected':''}>Nur Partner</option>
            <option value="affects_me" ${t.relevance==='affects_me'?'selected':''}>Betrifft mich</option>
          </select>
        </div>
      </div>
      <div class="termin-edit-actions">
        <button class="btn-save" onclick="saveEdit('${id}')">Speichern</button>
        <button class="btn-cancel-edit" onclick="loadTermine()">Abbrechen</button>
      </div>
    </div>`;
}

async function saveEdit(id) {
  const correction = {};
  const title = document.getElementById('edit-title-' + id)?.value;
  const dt = document.getElementById('edit-datetime-' + id)?.value;
  const location = document.getElementById('edit-location-' + id)?.value;
  const category = document.getElementById('edit-category-' + id)?.value;
  const relevance = document.getElementById('edit-relevance-' + id)?.value;

  if (title) correction.title = title;
  if (dt) correction.datetime = dt;
  if (location !== undefined) correction.location = location;
  if (category) correction.category = category;
  if (relevance) correction.relevance = relevance;

  try {
    await fetch(`/api/termine/${id}/feedback`, {
      method: 'POST', headers: headers(),
      body: JSON.stringify({action: 'edited', correction})
    });
    loadTermine();
  } catch (e) { console.error('Edit error:', e); }
}

function updateTerminUI(id, newStatus) {
  const li = document.getElementById('termin-' + id);
  if (!li) return;
  const actionsEl = document.getElementById('actions-' + id);
  if (actionsEl) {
    const color = newStatus === 'confirmed' ? 'var(--positive)' : 'var(--negative)';
    const label = newStatus === 'confirmed' ? '✓ Bestätigt' : '✗ Abgelehnt';
    actionsEl.innerHTML = `<div class="termin-feedback-done" style="color:${color}">${label}</div>`;
  }
  // Update badge
  const badge = li.querySelector('.termin-status-badge');
  if (badge) {
    badge.className = 'termin-status-badge badge-' + newStatus;
    const labels = {confirmed:'Bestätigt',rejected:'Abgelehnt'};
    badge.textContent = labels[newStatus] || newStatus;
  }
}

async function loadStatus() {
  try {
    const data = await apiFetch('/api/status');
    const grid = document.getElementById('serviceGrid');
    grid.innerHTML = data.services.map(s => `
      <div class="service-pill">
        <span class="service-dot ${s.status}"></span>
        ${esc(s.name)}
        <span class="service-detail">${esc(s.detail)}</span>
      </div>
    `).join('');
  } catch (e) {
    console.error('Status error:', e);
  }
}

async function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  const list = document.getElementById('searchResults');
  list.innerHTML = '<li class="empty-state">Suche...</li>';
  try {
    const data = await apiFetch(`/api/search?q=${encodeURIComponent(q)}&chat_id=${encodeURIComponent(CHAT_ID)}`);
    if (!data.results.length) {
      list.innerHTML = '<li class="empty-state">Keine Ergebnisse</li>';
      return;
    }
    list.innerHTML = data.results.map(r => `
      <li class="search-result-item">
        <div class="search-text">${esc(r.text)}</div>
        <div class="search-meta">${esc(r.sender)} &middot; ${r.timestamp || '-'} &middot; Relevanz: ${(1 - r.distance).toFixed(1)}</div>
      </li>
    `).join('');
  } catch (e) {
    list.innerHTML = `<li class="empty-state">Fehler: ${e.message}</li>`;
  }
}

function formatDate(iso) {
  try {
    const d = new Date(iso);
    return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
  } catch { return iso; }
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// Auto-login from localStorage
(function init() {
  const saved_key = localStorage.getItem('radar_key');
  const saved_chat = localStorage.getItem('radar_chat');
  if (saved_key && saved_chat) {
    document.getElementById('authKey').value = saved_key;
    document.getElementById('authChatId').value = saved_chat;
    authenticate();
  }
})();
</script>
</body>
</html>
